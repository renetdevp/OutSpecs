<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>outspecs - 게시판</title>
  <link rel="stylesheet" th:href="@{/css/post-list.css}">
</head>
<body>
    <header th:replace="~{fragments/header :: header}"></header>
    <div class="container" th:data-post-type="${postType.pathPrefix}">
      <section class="popular-section">
        <div class="list-title">인기게시글</div>
        <div class="popular-posts">
          <th:block th:each="post, iterStat : ${popularPosts}">
            <a th:href="@{/post/{id}(id=${post.id})}" class="popular-post">
              <div class="post-info">
                <div class="post-number" th:text="${iterStat.count}">1</div>
                <div class="post-title" th:text="${post.title}">게시글 제목</div>
                <div class="post-date" th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd')}">2025.08.10</div>
              </div>
              <div class="post-stats">
                <img class="post-popular-icon" src="/images/like-fill.svg" alt="좋아요 아이콘">
                <span class="likes" th:text="${post.likeCount}">0</span>
              </div>
            </a>
          </th:block>
        </div>
      </section>

      <div class="content-wrapper">
        <div class="tech-tags" th:if="${postType.name() == 'PLAY'}">
          <div class="filter-title-container">
            <div class="list-title">장소</div>
            <a th:href="@{/list/{postType}(postType=${postType.pathPrefix})}">초기화</a>
          </div>
          <div th:with="opts=${T(java.util.List).of('서울특별시','강원도','경기도','충청도','전라도','경상도')}">
            <div class="tag-list">
              <div th:if="${postType.name() == 'PLAY'}" class="tag-item" th:each="opt : ${opts}" th:text="${opt}" th:data-tag="${opt}"
                   th:classappend="${selectedTags != null and selectedTags.contains(opt)} ? ' active' : ''">서울특별시</div>
            </div>
          </div>
        </div>
        <div class="tech-tags" th:if="${postType.name() != 'PLAY'}">
          <div class="filter-title-container">
            <div class="list-title">태그</div>
            <a th:href="@{/list/{postType}(postType=${postType.pathPrefix})}">초기화</a>
          </div>
          <div th:with="opts=${T(java.util.List).of('Java','Spring','React','Vue','Python','AI','SQL', 'C++','C','JavaScript','HTML','CSS')}">
            <div class="tag-list">
              <div th:if="${postType.name() != 'PLAY'}" class="tag-item" th:each="opt : ${opts}" th:text="${opt}" th:data-tag="${opt}"
                   th:classappend="${selectedTags != null and selectedTags.contains(opt)} ? ' active' : ''">Java</div>
            </div>
          </div>
        </div>

        <main class="main-content">
          <a class="write-btn" th:if="${user != null}" th:href="@{/post/write}">글쓰기</a>
          <div class="post-list">
            <article class="post-item" th:each="post : ${recentPosts}">
                <div class="post-header">
                  <a th:if="${user != null and user.profile != null}"
                     class="post-user-image-link" th:href="@{/users/profiles/{id}(id=${post.user.id})}">
                    <img class="post-user-image" src="/images/profileImage.png" alt="프로필 이미지">
                  </a>
                  <img th:unless="${user != null and user.profile != null}"
                       class="post-user-image" src="/images/profileImage.png" alt="프로필 이미지">
                  <div class="post-title-container">
                    <div class="post-title-info">
                      <a th:if="${user != null and user.profile != null}"
                         th:href="@{/users/profiles/{id}(id=${post.user.id})}"
                         class="post-user-nickname" th:text="${post.user.profile.nickname}">사용자명</a>
                      <div th:unless="${user != null and user.profile != null}"
                         th:href="@{/users/profiles/{id}(id=${post.user.id})}"
                         class="post-user-nickname" th:text="${post.user.profile.nickname}">사용자명</div>
                      <div class="post-title" th:text="${post.title}">게시글 제목</div>
                    </div>
                    <div class="post-date" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</div>
                  </div>
                  <div class="more-menu-container" th:if="${user != null and user.id != post.user.id and user.profile != null}">
                    <img class="more-icon" src="/images/more-vertical.png" alt="더보기 아이콘"
                         th:onclick="|toggleMoreMenu(event, 'post-more-menu-${post.id}')|">
                    <div class="more-menu"  th:id="|post-more-menu-${post.id}|">
                      <button type="button" class="report-btn" th:onclick="|reportPost(${post.id})|">신고</button>
                    </div>
                  </div>
                </div>

                <a class="post-content" th:href="@{/post/{id}(id=${post.id})}">
                  <div th:if="${post.images}">
                    <div th:each="img : ${post.images}">
                      <img th:src="@{|/uploads/${img.fileName}|}" alt="첨부 이미지">
                    </div>
                  </div>
                  <pre th:text="${post.content}">게시글 내용</pre>
                </a>

                <div class="post-reaction">
                  <div class="post-reaction-count">
                    <div class="reaction-item">
                      <form th:action="@{/post/{postId}/like(postId=${post.id})}" method="post" style="display: inline;">
                        <button type="submit" class="like-btn" th:disabled="${user == null or user.id == post.user.id or user.profile == null}">
                          <img class="post-icon" src="/images/like.png" alt="좋아요 아이콘">
                        </button>
                      </form>
                      <span th:text="${post.likeCount}">0</span>
                    </div>
                    <div class="reaction-item">
                      <img class="post-icon" src="/images/view.png" alt="조회수 아이콘">
                      <span th:text="${post.viewCount}">0</span>
                    </div>
                    <div class="reaction-item">
                      <img class="post-icon" src="/images/comment.png" alt="댓글 아이콘">
                      <span th:text="${post.commentCount}">0</span>
                    </div>
                  </div>
                  <form th:action="@{/post/{postId}/bookmark(postId=${post.id})}" method="post" style="display: inline;">
                    <button type="submit" class="bookmark-btn" th:disabled="${user == null or user.id == post.user.id or user.profile == null}">
                      <img class="post-icon"  src="/images/bookmark.png" alt="북마크 아이콘">
                    </button>
                  </form>
                </div>
            </article>
          </div>
        </main>
      </div>
    </div>

    <div class="ai-chat" th:if="${user != null}">
      AI<br>챗봇
    </div>

    <script>
      // 태그 클릭 이벤트
      const container = document.querySelector('.container');
      const postTypePath = container.dataset.postType;

      document.querySelectorAll('.tag-item').forEach(tag => {
          tag.addEventListener('click', function() {
            if(postTypePath === 'play') {
                document.querySelectorAll('.tag-item').forEach(t => t.classList.remove('active'));
            }
            this.classList.toggle('active');
            const activeTags= Array.from(document.querySelectorAll('.tag-item.active'))
                                    .map(t => t.dataset.tag);
            const query = activeTags.map(t => `tags=${encodeURIComponent(t)}`).join('&');
            window.location.href = '/list/' + postTypePath + '/filter' + (query ? `?${query}` : '');
          });
      });

      // 게시글 클릭 이벤트
      document.querySelectorAll('.post-item').forEach(post => {
          post.addEventListener('click', function() {
              // 게시글 상세 페이지로 이동
              console.log('게시글 클릭됨');
          });
      });

       // More 메뉴 토글 함수
      function toggleMoreMenu(event, menuId) {
        event.stopPropagation();
        const menu = document.getElementById(menuId);
        const allMenus = document.querySelectorAll('.more-menu');

        // 다른 메뉴들 닫기
        allMenus.forEach(m => {
          if (m.id !== menuId) {
            m.style.display = 'none';
          }
        });

        // 현재 메뉴 토글
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
      }

        // 외부 클릭 시 메뉴 닫기
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.more-menu-container')) {
          const allMenus = document.querySelectorAll('.more-menu');
          allMenus.forEach(menu => {
            menu.style.display = 'none';
          });
        }
      });

      // 페이지 로드 시 스크롤 이벤트 추가 (메뉴 닫기)
      window.addEventListener('scroll', function() {
        const allMenus = document.querySelectorAll('.more-menu');
        allMenus.forEach(menu => {
          menu.style.display = 'none';
        });
      });

        // 게시글 신고 함수
      function reportPost(postId) {
        if (confirm('이 게시글을 신고하시겠습니까?')) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/post/' + postId + '/report';
          document.body.appendChild(form);
          form.submit();
        }
        document.getElementById('post-more-menu').style.display = 'none';
      }

      // AI 챗봇 클릭 이벤트
      document.querySelector('.ai-chat').addEventListener('click', function() {
          // AI 챗봇 열기
          console.log('AI 챗봇 클릭됨');
      });
    </script>
</body>
</html>