<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">게시글 상세</title>
  <link rel="stylesheet" th:href="@{/css/free-board-detail.css}">
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>
<div class="post">
  <a class="postlist-back post-btn" th:href="@{/free-board/latest}">← 목록으로</a>
  <div class="post-container">
    <div class="post-header">
      <img class="post-user-image" src="/images/profileImage.png" alt="프로필 이미지">
      <div class="post-title-container">
        <div class="post-title-info">
          <div class="post-user-nickname" th:text="${post.user.username}">사용자명</div>
          <div class="post-title" th:text="${post.title}">게시글 제목</div>
        </div>
        <div class="post-date" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</div>
      </div>
      <div class="more-menu-container">
        <img class="more-icon" src="/images/more-vertical.png" alt="더보기 아이콘" onclick="toggleMoreMenu(event, 'post-more-menu')">
        <div class="more-menu" id="post-more-menu">
          <button type="button" class="report-btn" onclick="reportPost()">신고</button>
        </div>
      </div>
    </div>

    <div class="post-content">
      <div th:if="${post.images}">
        <div th:each="img : ${post.images}">
          <img th:src="@{|/uploads/${img.fileName}|}" alt="첨부 이미지">
        </div>
      </div>
      <div th:text="${post.content}">게시글 내용</div>
    </div>

    <div class="post-reaction">
      <div class="post-reaction-count">
        <div class="reaction-item">
          <form th:action="@{/free-board/{postId}/like(postId=${post.id})}" method="post" style="display: inline;">
            <button type="submit" class="like-btn">
              <img class="post-icon" th:if="${!isLiked}" src="/images/like.png" alt="좋아요 아이콘">
              <img class="post-icon" th:if="${isLiked}" src="/images/like-fill.svg" alt="좋아요 아이콘">
            </button>
          </form>
          <span th:text="${likesCount}">0</span>
        </div>
        <div class="reaction-item">
          <img class="post-icon" src="/images/view.png" alt="조회수 아이콘">
          <span th:text="${post.viewCount}">0</span>
        </div>
        <div class="reaction-item">
          <img class="post-icon" src="/images/comment.png" alt="댓글 아이콘">
          <span th:text="${commentsCount}">0</span>
        </div>
      </div>
      <form th:action="@{/free-board/{postId}/bookmark(postId=${post.id})}" method="post" style="display: inline;">
        <button type="submit" class="bookmark-btn">
          <img class="post-icon" th:if="${!isBookmarked}" src="/images/bookmark.png" alt="북마크 아이콘">
          <img class="post-icon" th:if="${isBookmarked}" src="/images/bookmark-fill.svg" alt="북마크 아이콘">
        </button>
      </form>
    </div>

    <div th:if="${#lists.isEmpty(comments)}" class="no-comments">
      <p>아직 댓글이 없습니다. 첫 번째 댓글을 작성해보세요!</p>
    </div>

    <div class="comment comment-item" th:if="${!#lists.isEmpty(comments) && comment.type.name() == 'COMMENT'}"
         th:each="comment : ${comments}" th:attr="data-comment-id=${comment.id}">
      <div class="comment-info">
        <div class="comment-user-profile">
          <img class="user-image" src="/images/profileImage.png" alt="댓글 작성자 이미지">
          <div class="user-nickname" th:text="${comment.user.username}">유저 닉네임</div>
        </div>
        <div class="comment-content" th:text="${comment.content}">댓글 내용</div>
        <div class="comment-more">
          <img class="comment-more-icon" src="/images/more-vertical.png" alt="더보기 아이콘"
               th:onclick="'toggleMoreMenu(event, \'comment-more-menu-' + ${comment.id} + '\')'">
          <div class="comment-more-menu" th:id="'comment-more-menu-' + ${comment.id}">
            <button type="button" class="edit-btn" onclick="editComment(this)">수정</button>
            <form th:action="@{/free-board/{postId}/comment/{commentId}(postId=${post.id}, commentId=${comment.id})}"
                  method="post" style="display:inline;">
              <button class="delete-btn" type="submit" onclick="return confirm('댓글을 삭제하시겠습니까?')">삭제</button>
            </form>
          </div>
        </div>
      </div>

      <form th:action="@{/free-board/{postId}/comment/{commentId}/edit(postId=${post.id}, commentId=${comment.id})}"
            method="post" class="comment-edit-form" style="display:none;">
        <textarea class="comment-input" name="content" th:text="${comment.content}" placeholder="댓글 내용을 입력하세요" required maxlength="250"></textarea>
        <div class="comment-form-buttons">
          <button class="comment-btn" type="submit">수정 완료</button>
          <button class="comment-btn comment-cancel-btn" type="button" onclick="cancelEdit(this)">취소</button>
        </div>
      </form>

      <button class="comment-btn comment-btn-toggle" type="button"
              th:onclick="'showReplyForm(' + ${comment.id} + ', this)'">
        답글달기
      </button>

      <div class="comment-reply">
        <div class="comment-reply-list" th:each="reply : ${comments}"
             th:if="${reply.type.name() == 'REPLY' and reply.parentId == comment.id}">
          <div class="reply-header">
            <span class="reply-author" th:text="${reply.user.username}">대댓글 작성자</span>
            <span class="reply-date" th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}">작성시간</span>
          </div>
          <p class="reply-content" th:text="${reply.content}">대댓글 내용</p>
          <div class="reply-more">
            <img class="comment-more-icon" src="/images/more-vertical.png" alt="더보기 아이콘"
                 th:onclick="'toggleMoreMenu(event, \'reply-more-menu-' + ${reply.id} + '\')'">
            <div class="comment-more-menu" th:id="'reply-more-menu-' + ${reply.id}">
              <form th:action="@{/free-board/{postId}/comment/{commentId}(postId=${post.id}, commentId=${reply.id})}"
                    method="post" style="display:inline;">
                <button class="delete-btn" type="submit" onclick="return confirm('대댓글을 삭제하시겠습니까?')">삭제</button>
              </form>
            </div>
          </div>
        </div>

        <form th:action="@{/free-board/{postId}/comment(postId=${post.id})}" th:object="${commentDTO}"
              method="post" class="reply-form" th:id="'reply-form-' + ${comment.id}" style="display:none;">
          <input type="hidden" name="type" value="REPLY"/>
          <input type="hidden" name="parentId" th:value="${comment.id}" />
          <textarea class="comment-input" name="content" placeholder="대댓글 내용을 입력하세요" required></textarea>
          <div class="comment-form-buttons">
            <button class="comment-btn" type="submit">등록</button>
            <button type="button" class="comment-btn comment-cancel-btn"
                    th:onclick="'hideReplyForm(' + ${comment.id} + ')'">취소</button>
          </div>
        </form>
      </div>
    </div>

    <div class="comment new-comment-form">
      <form class="comment-info" th:action="@{/free-board/{postId}/comment(postId=${post.id})}" method="post"
            th:object="${commentDTO}">
        <div class="comment-user-profile">
          <img class="user-image" src="/images/profileImage.png" alt="작성자 이미지">
          <div class="user-nickname">유저 닉네임</div>
        </div>
        <div style="flex-grow: 1;">
          <input type="hidden" name="type" value="COMMENT"/>
          <input type="hidden" name="parentId" th:value="${post.id}"/>
          <textarea class="comment-input" th:field="*{content}" placeholder="댓글을 입력하세요" required maxlength="250"></textarea>
          <div class="comment-form-buttons">
            <button class="comment-btn" type="submit">등록하기</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="post-actions">
    <a class="post-btn" th:href="@{|/free-board/${post.id}/edit|}">수정하기</a>
    <form th:action="@{|/free-board/${post.id}/delete|}" method="post" style="display:inline;">
      <button class="post-btn delete-btn" type="submit" onclick="return confirm('게시글을 삭제하시겠습니까?')">삭제하기</button>
    </form>
  </div>
</div>

<script>
  // More 메뉴 토글 함수
  function toggleMoreMenu(event, menuId) {
    event.stopPropagation();
    const menu = document.getElementById(menuId);
    const allMenus = document.querySelectorAll('.more-menu, .comment-more-menu');

    // 다른 메뉴들 닫기
    allMenus.forEach(m => {
      if (m.id !== menuId) {
        m.style.display = 'none';
      }
    });

    // 현재 메뉴 토글
    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
  }

  // 게시글 신고 함수
  function reportPost() {
    if (confirm('이 게시글을 신고하시겠습니까?')) {
      // 신고 로직 구현 (컨트롤러로 요청)
      fetch('/free-board/' + [[${post.id}]] + '/report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      }).then(response => {
        if (response.ok) {
          alert('신고가 접수되었습니다.');
        } else {
          alert('신고 접수에 실패했습니다.');
        }
      }).catch(error => {
        console.error('Error:', error);
        alert('신고 접수 중 오류가 발생했습니다.');
      });
    }
    document.getElementById('post-more-menu').style.display = 'none';
  }

  // 댓글 수정 함수
  function editComment(button) {
    const commentItem = button.closest('.comment-item');
    const content = commentItem.querySelector('.comment-content');
    const editForm = commentItem.querySelector('.comment-edit-form');
    const moreMenu = button.closest('.comment-more-menu');

    content.style.display = 'none';
    editForm.style.display = 'block';
    moreMenu.style.display = 'none';
  }

  // 댓글 수정 취소 함수
  function cancelEdit(button) {
    const commentItem = button.closest('.comment-item');
    const content = commentItem.querySelector('.comment-content');
    const editForm = commentItem.querySelector('.comment-edit-form');

    content.style.display = 'block';
    editForm.style.display = 'none';
  }

  // 답글 폼 표시 함수
  function showReplyForm(commentId, toggleButton) {
    const replyForm = document.getElementById('reply-form-' + commentId);
    replyForm.style.display = 'block';
    toggleButton.style.display = 'none';
  }

  // 답글 폼 숨기기 함수
  function hideReplyForm(commentId) {
    const replyForm = document.getElementById('reply-form-' + commentId);
    const toggleButton = replyForm.parentElement.querySelector('.comment-btn-toggle');

    replyForm.style.display = 'none';
    toggleButton.style.display = 'inline-block';

    // 폼 내용 초기화
    const textarea = replyForm.querySelector('textarea');
    textarea.value = '';
  }

  // 외부 클릭 시 메뉴 닫기
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.more-menu-container') && !event.target.closest('.comment-more')) {
      const allMenus = document.querySelectorAll('.more-menu, .comment-more-menu');
      allMenus.forEach(menu => {
        menu.style.display = 'none';
      });
    }
  });

  // 페이지 로드 시 스크롤 이벤트 추가 (메뉴 닫기)
  window.addEventListener('scroll', function() {
    const allMenus = document.querySelectorAll('.more-menu, .comment-more-menu');
    allMenus.forEach(menu => {
      menu.style.display = 'none';
    });
  });
</script>

</body>
</html>